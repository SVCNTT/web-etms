angular.module("ui.calendar",[]).constant("uiCalendarConfig",{calendars:{}}).controller("uiCalendarCtrl",["$scope","$timeout","$locale",function(k,g,t){var l=1,h=1,p=k.eventSources,n=k.calendarWatchEvent?k.calendarWatchEvent:angular.noop,e=function(a){var b;a&&(b=function(){var d=arguments,c=this;g(function(){a.apply(c,d)})});return b};this.eventsFingerprint=function(a){a._id||(a._id=h++);return""+a._id+(a.id||"")+(a.title||"")+(a.url||"")+(+a.start||"")+(+a.end||"")+(a.allDay||"")+(a.className||
    "")+n(a)||""};this.sourcesFingerprint=function(a){return a.__id||(a.__id=l++)};this.allEvents=function(){for(var a=[],b=0,d=p.length;b<d;b++){var c=p[b];if(angular.isArray(c))a.push(c);else if(angular.isObject(c)&&angular.isArray(c.events)){var m={},r;for(r in c)"_uiCalId"!==r&&"events"!==r&&(m[r]=c[r]);for(var e=0;e<c.events.length;e++)angular.extend(c.events[e],m);a.push(c.events)}}return Array.prototype.concat.apply([],a)};this.changeWatcher=function(a,b){var d,c=function(){for(var c=angular.isFunction(a)?
    a():a,d=[],m,g,f=0,u=c.length;f<u;f++)g=c[f],m=b(g),e[m]=g,d.push(m);return d},m=function(c,a){var d=[],m={},f,b;f=0;for(b=a.length;f<b;f++)m[a[f]]=!0;f=0;for(b=c.length;f<b;f++)m[c[f]]||d.push(c[f]);return d},e={};return d={subscribe:function(a,g){a.$watch(c,function(c,a){if(!g||!1!==g(c,a)){var f,h,k,l,n={};l=m(a,c);f=0;for(h=l.length;f<h;f++){var q=l[f];k=e[q];delete e[q];var p=b(k);if(p===q)d.onRemoved(k);else n[p]=q,d.onChanged(k)}q=m(c,a);f=0;for(h=q.length;f<h;f++)if(l=q[f],k=e[l],!n[l])d.onAdded(k)}},
    !0)},onAdded:angular.noop,onChanged:angular.noop,onRemoved:angular.noop}};this.getFullCalendarConfig=function(a,b){var d={};angular.extend(d,b);angular.extend(d,a);angular.forEach(d,function(c,a){"function"===typeof c&&(d[a]=e(d[a]))});return d};this.getLocaleConfig=function(a){if(!a.lang||a.useNgLocale){a=function(a){var c,b;c=[];for(b in a)c[b]=a[b];return c};var b=t.DATETIME_FORMATS;return{monthNames:a(b.MONTH),monthNamesShort:a(b.SHORTMONTH),dayNames:a(b.DAY),dayNamesShort:a(b.SHORTDAY)}}return{}}}]).directive("uiCalendar",
    ["uiCalendarConfig",function(k){return{restrict:"A",scope:{eventSources:"=ngModel",calendarWatchEvent:"&"},controller:"uiCalendarCtrl",link:function(g,t,l,h){var p=g.eventSources,n=!1,e,a=h.changeWatcher(p,h.sourcesFingerprint),b=h.changeWatcher(h.allEvents,h.eventsFingerprint),d=null;g.destroy=function(){e&&e.fullCalendar&&e.fullCalendar("destroy");e=l.calendar?k.calendars[l.calendar]=$(t).html(""):$(t).html("")};g.init=function(){e.fullCalendar(d)};a.onAdded=function(a){e.fullCalendar("addEventSource",
        a);n=!0};a.onRemoved=function(a){e.fullCalendar("removeEventSource",a);n=!0};b.onAdded=function(a){e.fullCalendar("renderEvent",a)};b.onRemoved=function(a){e.fullCalendar("removeEvents",function(b){return b._id===a._id})};b.onChanged=function(a){a._start=$.fullCalendar.moment(a.start);a._end=$.fullCalendar.moment(a.end);e.fullCalendar("updateEvent",a)};a.subscribe(g);b.subscribe(g,function(a,b){if(!0===n)return n=!1});g.$watch(function(){var a=l.uiCalendar?g.$parent.$eval(l.uiCalendar):{},a=h.getFullCalendarConfig(a,
        k),b=h.getLocaleConfig(a);angular.extend(b,a);d={eventSources:p};angular.extend(d,b);d.calendars=null;var a={},e;for(e in d)"eventSources"!==e&&(a[e]=d[e]);return JSON.stringify(a)},function(a,b){g.destroy();g.init()})}}}]);